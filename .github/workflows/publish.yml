name: Publish Visual Effects

on:
    release:
        types: [ published ]

env:
    RELEASE_VERSION: ${{ github.event.release.tag_name }}

permissions:
    id-token: write

jobs:
    release:
        runs-on: ubuntu-latest
        steps:
            -   name: üëÄ Checkout latest source
                uses: actions/checkout@v4

            -   name: ‚öôÔ∏è Setup Bun
                uses: oven-sh/setup-bun@v2

            -   name: üì¶Ô∏è Install dependencies
                run: bun install --frozen-lockfile

            -   name: ‚úèÔ∏è Tag v${{ env.RELEASE_VERSION }}
                run: |
                    bun pm version --cwd packages/common ${{ env.RELEASE_VERSION }}
                    bun pm version --cwd packages/fireworks ${{ env.RELEASE_VERSION }}
                    bun pm version --cwd packages/snow ${{ env.RELEASE_VERSION }}
                    
                    sed -i 's/workspace:\*/${{ env.RELEASE_VERSION }}/g' packages/common/package.json
                    sed -i 's/workspace:\*/${{ env.RELEASE_VERSION }}/g' packages/fireworks/package.json
                    sed -i 's/workspace:\*/${{ env.RELEASE_VERSION }}/g' packages/snow/package.json

            -   name: üî® Build
                run: |
                    bun --cwd packages/common build
                    bun --cwd packages/fireworks build
                    bun --cwd packages/snow build

            -   name: üöÄ Publish v${{ env.RELEASE_VERSION }}
                run: |
                    bun publish --cwd packages/common --access public
                    bun publish --cwd packages/fireworks --access public
                    bun publish --cwd packages/snow --access public
                env:
                    NPM_CONFIG_TOKEN: ${{ secrets.NPM_TOKEN }}
